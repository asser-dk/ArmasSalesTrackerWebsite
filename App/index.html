<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <title>APB sales tracker</title>
    <link rel="stylesheet" href="components/font-awesome/css/font-awesome.css">
    <link rel="stylesheet" href="styles/index.css"/>
    <link rel="stylesheet" href="components/magnific-popup/dist/magnific-popup.css"/>
    <script src="components/jquery/dist/jquery.min.js"></script>
    <script src="components/modernizr/modernizr.js"></script>
    <script src="components/foundation/js/foundation.min.js"></script>
    <script src="components/foundation/js/foundation/foundation.topbar.js"></script>
    <script src="components/foundation/js/foundation/foundation.reveal.js"></script>
    <script src="components/foundation/js/foundation/foundation.abide.js"></script>
    <script src="components/foundation/js/foundation/foundation.tooltip.js"></script>
    <script src="components/magnific-popup/dist/jquery.magnific-popup.min.js"></script>
</head>
<body>
<nav class="top-bar" data-topbar role="navigation">
    <ul class="title-area">
        <li class="name">
            <h1><a href="http://sexyfishhorse.com" target="_blank">SexyFishHorse.com</a></h1>
        </li>
    </ul>

    <section class="top-bar-section">
        <ul class="left">
            <li>
                <a href="#">ARMAS Sales tracker</a>
            </li>
            <li class="divider"></li>
            <li>
                <a href="#" data-reveal-id="about-modal"><i class="fa fa-question-circle"></i> About</a>
            </li>
        </ul>
        <ul class="right">
            <li>
                <a href="https://github.com/asser-dk/ArmasSalesTrackerWebsite" target="_blank"><i
                        class="fa fa-github"></i> Source at GitHub</a>
            </li>
        </ul>
    </section>
</nav>
<div id="about-modal" class="reveal-modal" data-reveal>
    <h2>APB ARMAS sales tracker</h2>

    <p class="lead">Because 1 hour sales are a bitch to keep track of.</p>

    <p>I got fed up with spamming F5 in various one hour sales threads and then figure out I missed the sale that
        particular item on ARMAS during that one hour sale. The sales tracker gets the latest prices from ARMAS every
        hour. You can set up an email reminder for
        a particular item when it goes on sale.</p>

    <p>Please help me and post bugs, feature requests and feedback on
        <a href="http://github.com/asser-dk/ArmasSalesTrackerWebsite/issues"><i class="fa fa-github"></i> GitHub</a>
    </p>
    <i class="close-reveal-modal fa fa-close"></i>
</div>

<div class="large-4 columns large-centered search-bar">
    <p class="lead">Search for a product</p>

    <form data-abide>
        <div class="row collapse">
            <div class="small-10 columns">
                <input type="text" id="search-value" class="search-term-field" placeholder="Url, id or name"
                       autocomplete="off" required>
                <small class="error"><i class="fa fa-exclamation-triangle"></i> You must enter a search term.</small>
            </div>
            <div class="small-2 columns">
                <button type="submit" class="button postfix search-button"><i class="fa fa-search"></i> Search</button>
            </div>
        </div>
        <div class="row hide search-hint">
            <div class="small 12 columns">
                <label>This is</label>
                <input type="radio" name="search-hint" class="hint-text" value="Text" id="hint-text" required/>
                <label for="hint-text">Text</label>
                <input type="radio" name="search-hint" class="hint-id" value="Id" id="hint-id" required/>
                <label for="hint-id">An Id</label>
                <input type="radio" name="search-hint" class="hint-url" value="Url" id="hint-url" required/>
                <label for="hint-url">A Url</label>
            </div>
        </div>
    </form>
</div>
<div id="products-modal" class="reveal-modal" data-reveal>
    <h2>Search for '<span class="search-term"></span>'</h2>

    <div class="result-search-form">
        <form data-abide>
            <div class="row collapse">
                <div class="small-10 columns">
                    <input type="text" id="result-search-value" class="search-term-field" placeholder="Url, id or name"
                           autocomplete="off" required>
                    <small class="error"><i class="fa fa-exclamation-triangle"></i> You must enter a search term.
                    </small>
                </div>
                <div class="small-2 columns">
                    <button type="submit" class="button postfix search-button"><i class="fa fa-search"></i> Search
                    </button>
                </div>
            </div>
            <div class="row hide search-hint">
                <div class="small 12 columns">
                    <label>This is</label>
                    <input type="radio" name="search-hint" class="hint-text" value="Text" id="result-hint-text"
                           required/>
                    <label for="result-hint-text">Text</label>
                    <input type="radio" name="search-hint" class="hint-id" value="Id" id="result-hint-id" required/>
                    <label for="result-hint-id">An Id</label>
                    <input type="radio" name="search-hint" class="hint-url" value="Url" id="result-hint-url" required/>
                    <label for="result-hint-url">A Url</label>
                </div>
            </div>
        </form>
    </div>

    <div class="found-products hide">
        <p class="lead">These products were the best matches.</p>

        <p>The prices are at most an hour old. If any of these products have been removed from ARMAS then the
            displayed price is the latest price it had before it was taken down. Click on an item to learn more about
            the
            price history.</p>
        <ul class="product-results"></ul>
    </div>

    <div class="nothing-found hide">
        <h3>Oops.</h3>

        <p class="lead">We couldn't find what you were looking for :(</p>

        <p>We couldn't find anything that matched <strong><span id="not-found-resource"></span></strong>. Check your
            spelling or try to enter <a href="images/productId.png" target="_blank" class="image-link">the product
                id</a>
            instead (it is in the address bar when you see the item on ARMAS.</p>
    </div>
    <i class="close-reveal-modal fa fa-close"></i>
</div>
<script>
    window.fadeIn = function (obj)
    {
        $(obj).fadeIn(1000);
    };

    $(function ()
    {
        $(document).foundation({
            abide: {
                live_validation: false
            }
        });

        function showProduct(productId)
        {
        }

        $('.image-link').magnificPopup({type: 'image'});

        var productsModal = $('#products-modal');
        var searchTextField = $('#search-value');
        var resultSearchTextField = $('#result-search-value');

        searchTextField.on('change keypress paste focus textInput input', function ()
        {
            var text = searchTextField.val();
            resultSearchTextField.val(text);

            if (text.length > 0)
            {
                var n = ~~Number(text);
                if (String(n) === text && n > 1000)
                {
                    $('.hint-id').prop('checked', true);
                }
                else if (text.match('^http://'))
                {
                    $('.hint-url').prop('checked', true);
                }
                else
                {
                    $('.hint-text').prop('checked', true);
                }
                $('.search-hint').slideDown('slow');
            }
            else
            {
                $('.search-hint').slideUp('slow');
            }
        });

        resultSearchTextField.on('change keypress paste focus textInput input', function ()
        {
            var text = resultSearchTextField.val();
            searchTextField.val(text);

            if (text.length > 0)
            {
                var n = ~~Number(text);
                if (String(n) === text && n > 1000)
                {
                    $('.hint-id').prop('checked', true);
                }
                else if (text.match('^http://'))
                {
                    $('.hint-url').prop('checked', true);
                }
                else
                {
                    $('.hint-text').prop('checked', true);
                }
                $('.search-hint').slideDown('slow');
            }
            else
            {
                productsModal.find('.product-results').empty();
                $('.found-products').fadeOut('fast');
                $('.nothing-found').fadeOut('fast');
                $('.search-hint').slideUp('slow');
            }
        });

        $('.back-to-products').on('click', function ()
        {
            productsModal.foundation('reveal', 'open');
        });

        $('form').on('submit', function (e)
        {
            e.preventDefault();

            var hint = $('input[type="radio"][name="search-hint"]:checked').val();
            var text = searchTextField.val();

            if (!hint || !text)
            {
                return;
            }

            $('.search-term').text(text);
            $('#result-search-value').val(text);
            if (!productsModal.is(':visible'))
            {
                productsModal.foundation('reveal', 'open');
            }

            $.post('http://api.apbsales.sexyfishhorse.com/products/search',
                    JSON.stringify({'Term': text, 'Hint': hint})).done(function (data)
                    {
                        if (data && data.length > 0)
                        {
                            $('.nothing-found').slideUp('fast', function ()
                            {
                                $('.found-products').slideDown('slow');
                            });

                            for (var i = 0; i < data.length; i++)
                            {
                                var dataEntry = data[i];
                                var product = dataEntry.Product;
                                var latestPrices = dataEntry.History[0];

                                var result = '<li><div class="product" id="' + product.Id +
                                        '"><img onload="fadeIn(this)" class="product-image" src="' + product.ImageUrl +
                                        '" alt="' + product.Title + '"/><h3>' + product.Title +
                                        '</h3><div class="prices"><div class="price">' + latestPrices.Price +
                                        ' G1C</div>';

                                if (latestPrices.PremiumPrice > 0)
                                {
                                    result += '<div class="price premium">' +
                                    '<i class="fa fa-star premium-star has-tip" data-tooltip aria-haspopup="true" title="Premium"></i> ' +
                                    latestPrices.PremiumPrice + ' G1C</div>';
                                }

                                result += '</div></div></li>';
                                $(result).hide().prependTo('.product-results').slideDown('fast').delay(200);
                            }

                            $(document).foundation('tooltip', 'reflow');
                        }
                        else
                        {
                            $('.found-products').slideUp('fast', function ()
                            {
                                $('.nothing-found').slideDown('slow');
                            });
                        }
                    }).error(function (data)
                    {
                        console.error(data);
                        $('.found-products').slideUp('fast', function ()
                        {
                            $('.nothing-found').slideDown('slow');
                        });
                    });

            $('.product-results').on('click', '.product', function ()
            {
                showProduct(this.id);
            });
        })
    });
</script>
</body>
</html>
